# AWS DataSync & Amazon EFS ‚Äî Step-by-Step Practical Guide

---

## üß≠ Part 1: AWS DataSync

### üìò Overview

**AWS DataSync** is a fully managed service that simplifies and automates **data transfer between on-premises storage and AWS services** (such as Amazon S3, Amazon EFS, and Amazon FSx).

It can move **large datasets** efficiently, using an **agent-based** or **agentless** setup, while preserving metadata and ensuring encryption and integrity.

---

### üß© Prerequisites

Before starting:

* AWS account with proper permissions
* IAM role with **DataSync** and **target service (S3/EFS)** permissions
* Access to your **on-prem or self-managed storage** system (NFS/SMB)
* For on-prem ‚Üí AWS transfer: install the **DataSync agent**

---

### üë§ Step 1: Create IAM User or Role for DataSync

**IAM ‚Üí Roles ‚Üí Create Role**

* Trusted entity: `DataSync`
* Attach Policies:

  1. `AmazonDataSyncFullAccess`
  2. `AmazonS3FullAccess` *(if using S3 target)*
  3. `AmazonElasticFileSystemFullAccess` *(if using EFS target)*

‚úÖ Save the role ‚Äî AWS DataSync will assume it during transfer.

---

### ‚öôÔ∏è Step 2: Create a DataSync Agent (for On-Prem ‚Üí AWS)

If transferring from **on-premises**, you need an **agent** to connect to AWS.

1. Go to **AWS Console ‚Üí DataSync ‚Üí Agents ‚Üí Create agent**
2. Choose deployment type:

   * VMware (OVA)
   * Hyper-V (VHD)
   * Linux-based VM (Amazon EC2 or On-prem)
3. Deploy the agent and run:

   ```bash
   sudo ./dataynch-agent-installer --activation-key <your-key>
   ```
4. After activation, you‚Äôll see the agent appear as **‚ÄúONLINE‚Äù** in the AWS console.

üß† *Note:* If your data source is already in AWS (S3, EFS, FSx), no agent is needed.

---

### üóÇÔ∏è Step 3: Configure Source and Destination Locations

#### Example 1: On-Prem (NFS) ‚Üí Amazon EFS

1. In **AWS Console ‚Üí DataSync ‚Üí Locations ‚Üí Create Location**

   * **Location type:** NFS
   * **Mount path:** `/data`
   * **Server hostname:** your on-prem IP
   * **Agent:** select the agent you created
   * **Subdirectory:** optional (e.g., `/sales_data`)

2. Create another location:

   * **Location type:** Amazon EFS
   * **File system ID:** select your EFS
   * **Subdirectory:** e.g., `/migrated_data`
   * **Mount target:** automatically detected

---

### üß† Step 4: Create DataSync Task

Now link both locations into a task.

**AWS Console ‚Üí DataSync ‚Üí Tasks ‚Üí Create Task**

| Parameter            | Example                                                      |
| -------------------- | ------------------------------------------------------------ |
| Source Location      | On-prem NFS                                                  |
| Destination Location | Amazon EFS                                                   |
| Task Name            | `NFS-to-EFS-Migration`                                       |
| Task options         | Verify data, preserve timestamps, copy ownership/permissions |
| Schedule             | Manual or automated                                          |
| Logging              | Enable CloudWatch Logs (recommended)                         |

‚úÖ Click **Create Task**

---

### ‚ñ∂Ô∏è Step 5: Start Data Transfer

1. Select your created task.
2. Click **Start Task Execution**.
3. Monitor progress:

   * Throughput
   * File count
   * Duration
   * Error logs (if any)

Once complete, your data from NFS/SMB will appear in **Amazon EFS**.

---

### üìä Step 6: Monitor & Validate

Go to:
**DataSync ‚Üí Task executions ‚Üí [Your Task]**

Check:

* **Status:** SUCCESS
* **Files transferred:** count and size
* **Errors (if any):** detailed logs in CloudWatch

‚úÖ Verify files in the EFS mount point to confirm data integrity.

---

### ‚úÖ Summary (DataSync)

| Step | Action                                | Purpose                        |
| ---- | ------------------------------------- | ------------------------------ |
| 1    | Create IAM Role                       | Grant permissions to DataSync  |
| 2    | Deploy Agent                          | Connect on-prem storage to AWS |
| 3    | Create Source & Destination Locations | Define endpoints               |
| 4    | Create DataSync Task                  | Configure transfer job         |
| 5    | Start Task Execution                  | Begin data migration           |
| 6    | Monitor Progress                      | Verify transfer and logs       |

---

## üóÇÔ∏è Part 2: Amazon Elastic File System (EFS)

### üìò Overview

**Amazon EFS (Elastic File System)** provides a **scalable, shared file storage** system for use with **EC2**, **ECS**, **Lambda**, and **on-prem servers** via AWS Direct Connect or VPN.

It automatically scales as you add or remove files, and supports both **NFSv4.1** and **NFSv4.0** protocols.

---

### üß© Step 1: Create an EFS File System

**AWS Console ‚Üí EFS ‚Üí Create File System**

1. **File system name:** `my-efs-storage`
2. **VPC:** Select your VPC
3. Choose mode:

   * **Regional** (recommended for HA)
   * **One Zone** (for lower cost, single-AZ)
4. Enable encryption (KMS)
5. Click **Create**

---

### ‚öôÔ∏è Step 2: Configure Network Access

1. Under **Network ‚Üí Manage mount targets**

   * Ensure **subnets** exist for each Availability Zone
   * Assign **Security Group** with inbound NFS rule:

     ```
     Type: NFS
     Protocol: TCP
     Port Range: 2049
     Source: Your EC2 or on-prem network CIDR
     ```
2. Save changes

---

### üíª Step 3: Mount EFS on EC2 Instance

1. SSH into your EC2 instance
2. Install NFS utilities:

   ```bash
   sudo yum install -y nfs-utils
   ```
3. Create mount directory:

   ```bash
   sudo mkdir /mnt/efs
   ```
4. Mount the EFS:

   ```bash
   sudo mount -t nfs4 -o nfsvers=4.1 fs-12345678.efs.us-east-1.amazonaws.com:/ /mnt/efs
   ```
5. Verify:

   ```bash
   df -h /mnt/efs
   ```

---

### üì¶ Step 4: Automate Mounting (Optional)

To mount automatically after reboot:

Add this line to `/etc/fstab`:

```
fs-12345678.efs.us-east-1.amazonaws.com:/ /mnt/efs nfs4 defaults,_netdev 0 0
```

---

### ‚öôÔ∏è Step 5: Integrate with AWS DataSync (Optional)

You can use **DataSync** to:

* Move existing data into EFS
* Sync updates between EFS and on-prem storage

**Example:**

* Source: On-prem NFS
* Destination: EFS `/mnt/efs/migrated_data`
* Schedule: Every 6 hours

This setup ensures your on-prem file server stays in sync with EFS for hybrid environments.

---

### ‚úÖ Summary (EFS)

| Step | Action                   | Purpose                       |
| ---- | ------------------------ | ----------------------------- |
| 1    | Create EFS File System   | Set up scalable storage       |
| 2    | Configure Network Access | Enable secure NFS access      |
| 3    | Mount on EC2             | Access and store data         |
| 4    | Automate Mount           | Persist after reboot          |
| 5    | Integrate with DataSync  | Automate migrations and syncs |

---

## üîó Combined Flow: DataSync + EFS

```
+---------------------+       +-----------------+       +--------------------+
| On-Prem File Server | <---> | AWS DataSync    | --->  | Amazon EFS Storage |
| (NFS / SMB)         |       | Agent + Task    |       | Accessible by EC2  |
+---------------------+       +-----------------+       +--------------------+
```

### How It Works:

1. Deploy DataSync Agent in your on-prem environment.
2. Create **NFS (source)** and **EFS (destination)** locations.
3. Configure **DataSync task** to transfer files.
4. Mount EFS to EC2 or Lambda ‚Äî all migrated data is now accessible in AWS.

---

## üß† Best Practices

* Enable **DataSync task logging** in CloudWatch.
* Use **VPC Endpoints** for secure private transfers.
* Schedule regular sync jobs for ongoing data replication.
* Use **EFS Lifecycle Policies** to move infrequently used files to **EFS-IA (Infrequent Access)** to reduce cost.
* Monitor with **Amazon CloudWatch ‚Üí EFS metrics** (`BurstCreditBalance`, `PercentIOLimit`).

---

## ‚úÖ Quick Recap

| Service         | Purpose                           | Key Action                             |
| --------------- | --------------------------------- | -------------------------------------- |
| **DataSync**    | Move data between on-prem and AWS | Create agent, locations, and task      |
| **EFS**         | Scalable shared file system       | Create file system, mount on EC2       |
| **Integration** | Hybrid data architecture          | Use DataSync to migrate or sync to EFS |

